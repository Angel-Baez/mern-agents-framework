name: Update Audit Epic Metrics

on:
  issues:
    types: [opened, closed, labeled, unlabeled, edited]
  workflow_dispatch:

jobs:
  update-epic:
    # Solo ejecutar para issues con label 'audit' que NO sean el epic
    if: |
      contains(github.event.issue.labels.*.name, 'audit') &&
      github.event.issue.number != 7
    
    runs-on: ubuntu-latest
    
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install @octokit/rest
      
      - name: Calculate metrics and update Epic
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const epicNumber = 7;
            
            // Obtener todos los sub-issues de auditor√≠a
            const { data: allIssues } = await github.rest.issues.listForRepo({
              owner,
              repo,
              labels: 'audit',
              state: 'all',
              per_page: 100
            });
            
            // Filtrar sub-issues (excluir el epic)
            const subIssues = allIssues.filter(issue => issue.number !== epicNumber);
            
            // Calcular m√©tricas
            const total = subIssues.length;
            const successes = subIssues.filter(i => 
              i.labels.some(l => l.name === 'case-success')
            ).length;
            const majorViolations = subIssues.filter(i => 
              i.labels.some(l => l.name === 'case-violation-major')
            ).length;
            const minorViolations = subIssues.filter(i => 
              i.labels.some(l => l.name === 'case-violation-minor')
            ).length;
            const successRate = total > 0 ? ((successes / total) * 100).toFixed(1) : 0;
            
            // M√©tricas por agente
            const agentStats = {};
            const agentLabels = [
              'orchestrator', 'backend-architect', 'frontend-architect',
              'data-engineer', 'solution-architect', 'security-guardian',
              'test-engineer', 'qa-lead', 'code-reviewer',
              'documentation-engineer', 'ai-integration-engineer',
              'observability-engineer', 'product-manager',
              'release-manager', 'devops-engineer'
            ];
            
            agentLabels.forEach(agent => {
              const agentIssues = subIssues.filter(i =>
                i.labels.some(l => l.name === `agent:${agent}`)
              );
              const agentSuccesses = agentIssues.filter(i =>
                i.labels.some(l => l.name === 'case-success')
              ).length;
              
              if (agentIssues.length > 0) {
                agentStats[agent] = {
                  total: agentIssues.length,
                  successes: agentSuccesses,
                  violations: agentIssues.length - agentSuccesses,
                  rate: ((agentSuccesses / agentIssues.length) * 100).toFixed(0)
                };
              }
            });
            
            // M√©tricas por entorno
            const vscodeIssues = subIssues.filter(i =>
              i.labels.some(l => l.name === 'env:vscode')
            );
            const githubIssues = subIssues.filter(i =>
              i.labels.some(l => l.name === 'env:github-copilot')
            );
            
            const vscodeViolations = vscodeIssues.filter(i =>
              i.labels.some(l => l.name.includes('violation'))
            ).length;
            const githubViolations = githubIssues.filter(i =>
              i.labels.some(l => l.name.includes('violation'))
            ).length;
            
            // Generar tabla de agentes
            let agentTable = '| Agente | Casos | √âxitos | Violaciones | % √âxito |\n';
            agentTable += '|--------|-------|--------|-------------|---------|\\n';
            
            Object.entries(agentStats)
              .sort((a, b) => b[1].rate - a[1].rate)
              .forEach(([agent, stats]) => {
                const emoji = stats.rate == 100 ? 'üèÜ' : stats.rate >= 50 ? '‚ö†Ô∏è' : '‚ùå';
                agentTable += `| ${agent} | ${stats.total} | ${stats.successes} | ${stats.violations} | ${stats.rate}% ${emoji} |\\n`;
              });
            
            // Agrupar sub-issues por resultado
            const successIssues = subIssues.filter(i =>
              i.labels.some(l => l.name === 'case-success')
            );
            const majorIssues = subIssues.filter(i =>
              i.labels.some(l => l.name === 'case-violation-major')
            );
            const minorIssues = subIssues.filter(i =>
              i.labels.some(l => l.name === 'case-violation-minor')
            );
            
            // Generar listas de sub-issues
            let successList = successIssues.map(i =>
              `- #${i.number} - ${i.title}`
            ).join('\\n');
            
            let majorList = majorIssues.map(i =>
              `- #${i.number} - ${i.title}`
            ).join('\\n');
            
            let minorList = minorIssues.map(i =>
              `- #${i.number} - ${i.title}`
            ).join('\\n');
            
            // Generar clasificaci√≥n
            let classification = '';
            const totalViolations = majorViolations + minorViolations;
            if (totalViolations === 0) {
              classification = '- [x] 0 fallos ‚Äì **A+ Perfecto**\\n- [ ] 1-3 fallos ‚Äì **Ajuste menor**\\n- [ ] 4-10 fallos ‚Äì **Ajuste moderado**\\n- [ ] 11+ fallos ‚Äì **Revisi√≥n profunda**';
            } else if (totalViolations <= 3) {
              classification = '- [ ] 0 fallos ‚Äì **A+ Perfecto**\\n- [x] 1-3 fallos ‚Äì **Ajuste menor** ‚Üê Estamos aqu√≠\\n- [ ] 4-10 fallos ‚Äì **Ajuste moderado**\\n- [ ] 11+ fallos ‚Äì **Revisi√≥n profunda**';
            } else if (totalViolations <= 10) {
              classification = '- [ ] 0 fallos ‚Äì **A+ Perfecto**\\n- [ ] 1-3 fallos ‚Äì **Ajuste menor**\\n- [x] 4-10 fallos ‚Äì **Ajuste moderado** ‚Üê Estamos aqu√≠\\n- [ ] 11+ fallos ‚Äì **Revisi√≥n profunda**';
            } else {
              classification = '- [ ] 0 fallos ‚Äì **A+ Perfecto**\\n- [ ] 1-3 fallos ‚Äì **Ajuste menor**\\n- [ ] 4-10 fallos ‚Äì **Ajuste moderado**\\n- [x] 11+ fallos ‚Äì **Revisi√≥n profunda** ‚Üê Estamos aqu√≠';
            }
            
            // Construir el body actualizado del Epic
            const epicBody = `# üìä [EPIC] Auditor√≠a de 100 Usos - Framework de 15 Agentes

**Ciclo:** 2025-12-06  
**Objetivo:** 0 violaciones en 100 usos reales  
**Progreso:** ${total}/100 casos (${((total/100)*100).toFixed(0)}%)

---

## üìà M√©tricas Globales

| M√©trica | Valor | Porcentaje |
|---------|-------|------------|
| **Casos completados** | ${total}/100 | ${((total/100)*100).toFixed(0)}% |
| **√âxitos totales** | ${successes} | ${successRate}% |
| **Violaciones mayores** | ${majorViolations} | ${total > 0 ? ((majorViolations/total)*100).toFixed(0) : 0}% |
| **Violaciones menores** | ${minorViolations} | ${total > 0 ? ((minorViolations/total)*100).toFixed(0) : 0}% |
| **Tasa de cumplimiento perfecto** | ${successRate}% | - |

---

## ü§ñ Rendimiento por Agente

${agentTable}

---

## üíª Rendimiento por Entorno

| Entorno | Casos | Violaciones | % √âxito |
|---------|-------|-------------|---------|
| VSCode | ${vscodeIssues.length} | ${vscodeViolations} | ${vscodeIssues.length > 0 ? (((vscodeIssues.length - vscodeViolations) / vscodeIssues.length) * 100).toFixed(0) : 0}% |
| GitHub Copilot Chat | ${githubIssues.length} | ${githubViolations} | ${githubIssues.length > 0 ? (((githubIssues.length - githubViolations) / githubIssues.length) * 100).toFixed(0) : 0}% |

---

## üìã Sub-issues (Casos Individuales)

### ‚úÖ Casos Exitosos (${successIssues.length})
${successList || '_Ninguno a√∫n_'}

### ‚ùå Violaciones Mayores (${majorIssues.length})
${majorList || '_Ninguna a√∫n_'}

### ‚ö†Ô∏è Violaciones Menores (${minorIssues.length})
${minorList || '_Ninguna a√∫n_'}

---

## üéØ Resultado Actual

**Clasificaci√≥n:** ${totalViolations === 0 ? 'A+ Perfecto' : totalViolations <= 3 ? 'Ajuste menor' : totalViolations <= 10 ? 'Ajuste moderado' : 'Revisi√≥n profunda'}

${classification}

---

## üìä Dashboard Interactivo

[Ver Dashboard Completo ‚Üí](../../docs/audit-results/dashboard.html)

El dashboard incluye:
- Gr√°ficos de tendencias
- Filtros por agente/entorno
- Desglose de tipos de violaci√≥n
- Exportaci√≥n a PDF

---

## üè∑Ô∏è C√≥mo Contribuir

Para agregar un nuevo caso de auditor√≠a:
1. Crear nuevo issue con template \`audit-case.yml\`
2. Etiquetar con \`audit\` y agregar al milestone correspondiente
3. Agregar labels espec√≠ficos: \`agent:*\`, \`env:*\`, \`case-*\`
4. Este Epic se actualizar√° autom√°ticamente

---

**√öltima actualizaci√≥n:** ${new Date().toISOString().split('T')[0]} (autom√°tica v√≠a GitHub Actions)`;
            
            // Actualizar el Epic #7
            await github.rest.issues.update({
              owner,
              repo,
              issue_number: epicNumber,
              body: epicBody
            });
            
            console.log(`‚úÖ Epic #${epicNumber} updated successfully!`);
            console.log(`üìä Metrics: ${total} cases, ${successes} successes, ${successRate}% success rate`);
